generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

enum TargetType {
  CLASS
  STUDENT
  GROUP
}

enum HomeworkType {
  TEXT
  FILE
  AUDIO
  MIXED
}

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  student      Student?
  teacher      Teacher?
  announcements Announcement[]

  @@map("users")
}

model Level {
  id        String   @id @default(uuid())
  name      String   @unique // A1, A2, B1, B2
  sortOrder Int      @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  classes          Class[]
  homeworks        Homework[]
  assignments      Assignment[]
  teacherResources TeacherResource[]

  @@map("levels")
}

model Class {
  id        String   @id @default(uuid())
  name      String   // A, B, C
  levelId   String   @map("level_id")
  createdAt DateTime @default(now()) @map("created_at")

  level               Level                @relation(fields: [levelId], references: [id], onDelete: Cascade)
  students            Student[]
  assignmentTargets   AssignmentTarget[]
  attendanceSessions  AttendanceSession[]
  timelinePosts       TimelinePost[]

  @@unique([name, levelId])
  @@map("classes")
}

model Student {
  id             String   @id @default(uuid())
  userId         String   @unique @map("user_id")
  classId        String   @map("class_id")
  enrollmentDate DateTime @default(now()) @map("enrollment_date")
  createdAt      DateTime @default(now()) @map("created_at")

  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  class              Class                @relation(fields: [classId], references: [id], onDelete: Cascade)
  submissions        Submission[]
  assignmentTargets  AssignmentTarget[]
  groupMembers       GroupMember[]
  attendanceRecords  AttendanceRecord[]
  peerReviewsGiven   PeerReview[]
  errorBankEntries   ErrorBankEntry[]
  interventionLogs   InterventionLog[]

  @@map("students")
}

model Teacher {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  homeworks          Homework[]
  assignments        Assignment[]
  groups             Group[]
  evaluations        Evaluation[]
  attendanceSessions AttendanceSession[]
  timelinePosts      TimelinePost[]
  teacherResources   TeacherResource[]
  errorBankEntries   ErrorBankEntry[]
  interventionLogs   InterventionLog[]

  @@map("teachers")
}

/// Hocanın oluşturduğu taslak. Metin, dosya, ses veya karışık (MIXED) türünde olabilir.
model Homework {
  id           String      @id @default(uuid())
  teacherId    String      @map("teacher_id")
  title        String
  description  String?     @db.Text
  instructions String?     @db.Text
  type         HomeworkType @default(TEXT)
  fileUrl      String?
  audioUrl     String?
  levelId      String      @map("level_id")
  weekNumber   Int         @map("week_number")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  teacher     Teacher      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  level       Level        @relation(fields: [levelId], references: [id], onDelete: Cascade)
  assignments Assignment[]

  @@map("homeworks")
}

/// Öğrenciye atanan ödev (tarih, hedef sınıf/öğrenci). Taslaktan üretilebilir (homeworkId) veya doğrudan oluşturulabilir.
model Assignment {
  id          String   @id @default(uuid())
  homeworkId  String?  @map("homework_id")
  title       String
  description String?  @db.Text
  levelId     String   @map("level_id")
  weekNumber  Int      @map("week_number")
  createdBy   String   @map("created_by")
  startDate   DateTime @map("start_date")
  dueDate     DateTime @map("due_date")
  isDraft              Boolean  @default(false) @map("is_draft")
  peerReviewEnabled    Boolean  @default(false) @map("peer_review_enabled")
  peerReviewsPerStudent Int     @default(2) @map("peer_reviews_per_student")
  attachments         Json     @default("[]")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  homework   Homework?  @relation(fields: [homeworkId], references: [id], onDelete: SetNull)
  level      Level      @relation(fields: [levelId], references: [id], onDelete: Cascade)
  teacher    Teacher    @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  targets     AssignmentTarget[]
  groups      Group[]
  submissions Submission[]

  @@map("assignments")
}

model AssignmentTarget {
  id           String     @id @default(uuid())
  assignmentId String     @map("assignment_id")
  targetType   TargetType @map("target_type")
  classId      String?    @map("class_id")
  studentId    String?    @map("student_id")
  groupId      String?    @map("group_id")
  createdAt    DateTime   @default(now()) @map("created_at")

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  class      Class?     @relation(fields: [classId], references: [id], onDelete: Cascade)
  student    Student?   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group      Group?     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("assignment_targets")
}

model Group {
  id           String   @id @default(uuid())
  assignmentId String   @map("assignment_id")
  name         String?
  createdBy    String   @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")

  assignment Assignment         @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  teacher    Teacher            @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  members    GroupMember[]
  targets    AssignmentTarget[]
  submissions Submission[]

  @@map("groups")
}

model GroupMember {
  groupId   String   @map("group_id")
  studentId String   @map("student_id")
  joinedAt  DateTime @default(now()) @map("joined_at")

  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@id([groupId, studentId])
  @@map("group_members")
}

model Submission {
  id           String   @id @default(uuid())
  assignmentId String   @map("assignment_id")
  studentId    String?  @map("student_id")
  groupId     String?  @map("group_id")
  submittedAt  DateTime @default(now()) @map("submitted_at")
  isLate       Boolean  @map("is_late")
  contentText  String?  @db.Text @map("content_text")
  attachments  Json     @default("[]")
  audioUrl     String?
  fileUrl      String?
  createdAt    DateTime @default(now()) @map("created_at")

  assignment  Assignment   @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student     Student?     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group       Group?       @relation(fields: [groupId], references: [id], onDelete: Cascade)
  evaluation      Evaluation?
  peerReviews     PeerReview[]
  errorBankEntries ErrorBankEntry[]

  @@map("submissions")
}

/// Akran değerlendirme: öğrenci başka bir öğrencinin teslimini anonim kriterlere göre puanlar.
model PeerReview {
  id              String   @id @default(uuid())
  submissionId    String   @map("submission_id")
  reviewerStudentId String @map("reviewer_student_id")
  score           Decimal  @db.Decimal(3, 1)
  criteriaScores  Json?    @map("criteria_scores")
  feedback        String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  reviewer   Student    @relation(fields: [reviewerStudentId], references: [id], onDelete: Cascade)

  @@unique([submissionId, reviewerStudentId])
  @@map("peer_reviews")
}

model Evaluation {
  id             String   @id @default(uuid())
  submissionId   String   @unique @map("submission_id")
  teacherId     String   @map("teacher_id")
  score         Decimal? @db.Decimal(5, 2)
  feedback      String?  @db.Text
  accepted      Boolean  @default(false)
  annotationData Json?   @map("annotation_data")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  teacher    Teacher    @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("evaluations")
}

/// Hoca yoklama başlattığında oluşan oturum. Kod 4–6 haneli, süre sınırlı.
model AttendanceSession {
  id        String   @id @default(uuid())
  code      String   @unique
  classId   String   @map("class_id")
  teacherId String   @map("teacher_id")
  startTime DateTime @map("start_time")
  endTime   DateTime @map("end_time")
  latitude  Float?
  longitude Float?
  createdAt DateTime @default(now()) @map("created_at")

  class    Class              @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher  Teacher            @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  records  AttendanceRecord[]

  @@map("attendance_sessions")
}

/// Öğrencinin bir yoklama oturumuna katılımı. Bir öğrenci aynı oturuma sadece bir kez kayıt olur.
model AttendanceRecord {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  studentId String   @map("student_id")
  joinedAt  DateTime @default(now()) @map("joined_at")
  latitude  Float?
  longitude Float?
  locationOk Boolean @default(false) @map("location_ok")
  rejectReason String? @map("reject_reason")

  session AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@map("attendance_records")
}

/// Duyurular: "Bu Cuma Speaking Club", "Haftaya sınav" vb. Admin/öğretmen oluşturur.
model Announcement {
  id        String   @id @default(uuid())
  title     String
  body      String   @db.Text
  authorId  String?  @map("author_id")
  createdAt DateTime @default(now()) @map("created_at")

  author User? @relation(fields: [authorId], references: [id], onDelete: SetNull)

  @@map("announcements")
}

/// Sınıfın Zaman Tüneli: Hocanın ders sonrası paylaştığı günlük özet (konu, foto, link).
model TimelinePost {
  id        String   @id @default(uuid())
  classId   String   @map("class_id")
  teacherId String   @map("teacher_id")
  summary   String   @db.Text
  imageUrl  String?  @map("image_url")
  linkUrl   String?  @map("link_url")
  postDate  DateTime @map("post_date")
  createdAt DateTime @default(now()) @map("created_at")

  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("timeline_posts")
}

/// Ders Paylaşım Havuzu: Hocalar arası ortak materyal kütüphanesi.
model TeacherResource {
  id          String   @id @default(uuid())
  teacherId   String   @map("teacher_id")
  title       String
  description String? @db.Text
  fileUrl     String?  @map("file_url")
  linkUrl     String?  @map("link_url")
  levelId     String?  @map("level_id")
  createdAt   DateTime @default(now()) @map("created_at")

  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  level   Level?  @relation(fields: [levelId], references: [id], onDelete: SetNull)

  @@map("teacher_resources")
}

/// Hata Bankası: Öğrenciye özel, hocanın eklediği hatalar (dikkat etmesi gerekenler).
model ErrorBankEntry {
  id           String   @id @default(uuid())
  studentId    String   @map("student_id")
  teacherId    String   @map("teacher_id")
  errorText    String   @db.Text @map("error_text")
  submissionId String?  @map("submission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  student    Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher    Teacher     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  submission Submission? @relation(fields: [submissionId], references: [id], onDelete: SetNull)

  @@map("error_bank_entries")
}

/// Hoca Müdahale Takvimi: Devamsızlık/kaçan ödev sonrası müdahale kaydı.
model InterventionLog {
  id        String   @id @default(uuid())
  studentId String   @map("student_id")
  teacherId String   @map("teacher_id")
  reason    String   @db.Text
  note      String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("intervention_logs")
}
